{
  "openapi": "3.0.3",
  "info": {
    "title": "Deployment API",
    "description": "This is the documentation of the rest api to perform operations on the namespace containing the automatic deploy project",
    "contact": {
      "email": "miguel@cysnet.es"
    },
    "license": {
      "name": "Apache 2.0",
      "url": "http://www.apache.org/licenses/LICENSE-2.0.html"
    },
    "version": "0.1.0"
  },
  "servers": [
    {
      "url": "https://www.cun.es/esbapi-iam/desa/cd"
    }
  ],
  "paths": {
    "/deploy/{namespace}": {
      "post": {
        "tags": [
          "deploy"
        ],
        "description": "Deploy namespace code from git repository",
        "operationId": "runDeploy",
        "parameters": [
          {
            "name": "namespace",
            "in": "path",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "requestBody": {
          "description": "Override configuration",
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/Configuration"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "Successful operation",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ApiResponse"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "Configuration": {
        "type": "object",
        "properties": {
          "production": {
            "type": "string",
            "example": "cysnet.cun.b2b.B2BProduction"
          },
          "deployActions": {
            "type": "array",
            "items": {
              "anyOf": [
                {
                  "$ref": "#/components/schemas/ActionStopProduction"
                },
                {
                  "$ref": "#/components/schemas/ActionStartProduction"
                },
                {
                  "$ref": "#/components/schemas/ActionRestartProduction"
                },
                {
                  "$ref": "#/components/schemas/ActionCreateBackup"
                },
                {
                  "$ref": "#/components/schemas/ActionGitClone"
                },
                {
                  "$ref": "#/components/schemas/ActionImportFiles"
                },
                {
                  "$ref": "#/components/schemas/ActionClear"
                },
                {
                  "$ref": "#/components/schemas/ActionAddItem"
                },
                {
                  "$ref": "#/components/schemas/ActionRestartItem"
                },
                {
                  "$ref": "#/components/schemas/ActionImportDefaultSettings"
                }
              ]
            }
          },
          "fileRemoveSearches": {
            "type": "string",
            "example": "src/CSP,src/.settings,.vscode,.gitignore,README.md,.git,.code-workspace"
          },
          "repositoryUrl": {
            "type": "string",
            "example": "cysnetsoftware@vs-ssh.visualstudio.com:v3/cysnetsoftware/CUN%20SI/ESB-B2B"
          },
          "repositoryBranch": {
            "type": "string",
            "example": "int"
          },
          "wildCards": {
            "type": "string",
            "example": "*"
          },
          "qspec": {
            "type": "string",
            "example": "ck"
          },
          "backupPath": {
            "type": "string",
            "example": "./B2B-backups"
          },
          "temporalPath": {
            "type": "string",
            "example": "./B2B-temp"
          },
          "clearPackages": {
            "type": "string",
            "example": "cysnet"
          },
          "classesNotClear": {
            "type": "string",
            "example": "cysnet.cun.b2b.B2BProduction"
          },
          "backupLimit": {
            "type": "integer",
            "example": 5
          },
          "logLimit": {
            "type": "integer",
            "example": 5
          },
          "deployLastMerge": {
            "type": "boolean",
            "example": true
          },
          "retriesOnFailure": {
            "type": "integer",
            "example": 2
          }
        }
      },
      "ActionStopProduction": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string",
            "default": "stopProduction"
          }
        }
      },
      "ActionStartProduction": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string",
            "default": "startProduction"
          }
        }
      },
      "ActionRestartProduction": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string",
            "default": "restartProduction"
          }
        }
      },
      "ActionCreateBackup": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string",
            "default": "createBackup"
          }
        }
      },
      "ActionGitClone": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string",
            "default": "gitClone"
          }
        }
      },
      "ActionImportFiles": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string",
            "default": "importFiles"
          },
          "wildCards": {
            "type": "string",
            "default": "*"
          },
          "qspec": {
            "type": "string",
            "default": "ck"
          }
        }
      },
      "ActionClear": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string",
            "default": "clear"
          },
          "clearPackages": {
            "type": "string",
            "default": "cysnet"
          },
          "classesNotClear": {
            "type": "string",
            "default": "cysnet.cun.b2b.B2BProduction"
          }
        }
      },
      "ActionAddItem": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string",
            "default": "addItem"
          },
          "name": {
            "type": "string",
            "default": "WSUsuariosService"
          },
          "class": {
            "type": "string",
            "default": "cysnet.bo.WSUsuariosService"
          },
          "configurations": {
            "type": "array",
            "items": {
              "anyOf": [
                {
                  "$ref": "#/components/schemas/ItemConfiguration"
                }
              ]
            }
          },
          "overwrite": {
            "type": "boolean",
            "default": true
          }
        }
      },
      "ActionRestartItem": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string",
            "default": "restartItem"
          },
          "item": {
            "type": "string",
            "default": "Namespace"
          }
        }
      },
      "ActionImportDefaultSettings": {
        "type": "object",
        "properties": {
          "type": {
            "type": "string",
            "default": "importDefaultSettings"
          },
          "items": {
            "type": "array",
            "items": {
              "anyOf": [
                {
                  "$ref": "#/components/schemas/ItemDefaultSettings"
                }
              ]
            }
          },
          "overwrite": {
            "type": "boolean",
            "default": true
          }
        }
      },
      "ItemDefaultSettings": {
        "type": "object",
        "properties": {
          "production": {
            "type": "string",
            "default": "*"
          },
          "item": {
            "type": "string",
            "default": "UserService"
          },
          "class": {
            "type": "string",
            "default": "cysnet.UserService"
          },
          "setting": {
            "type": "string",
            "default": "PortNumber"
          },
          "value": {
            "type": "string",
            "default": "1961"
          },
          "deployable": {
            "type": "boolean",
            "default": true
          },
          "description": {
            "type": "string",
            "default": "User service port number"
          }
        }
      },
      "ItemConfiguration": {
        "type": "object",
        "properties": {
          "name": {
            "type": "string",
            "default": "WebServiceURL"
          },
          "value": {
            "type": "string",
            "default": "http://localhost:8080"
          }
        }
      },
      "ApiResponse": {
        "type": "object",
        "properties": {
          "result": {
            "type": "boolean"
          },
          "logInfo": {
            "type": "string"
          }
        }
      }
    }
  }
}
